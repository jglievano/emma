;;; core.el --- The deepest of the sea. -*- lexical-binding: t; -*-

;;; Naming conventions:
;;
;;   njord-...  public variables or non-interactive functions.
;;   njord--... private anything (non-interactive), unsafe for direct use.
;;   njord/...  an interactive function. Safe for M-x or keybinding.
;;   njord:...  an evil operator, motion or command.
;;   njord|...  hook function.
;;   njord*...  advising functions.
;;   ...!      a macro or function that configures Njord.
;;   %...      functions used for in-snippet logic.
;;   +...      any of the above but part of a module, e.g. `+emacs-lisp|init-hook'
;;

(defvar njord-version "1.1.0"
  "Current Njord version.")

(defvar njord-debug-mode (or (getenv "DEBUG") init-file-debug)
  "If non-nil, all njord functions will be verbose. Set DEBUG=1 or use
--debug-init to enable.")

(defvar njord-emacs-dir (expand-file-name user-emacs-directory)
  "The path to this emacs directory.")

(defvar njord-core-dir (concat njord-emacs-dir "core/")
  "Core files.")

(defvar njord-modules-dir (concat njord-emacs-dir "modules/")
  "Module configuration files.")

(defvar njord-local-dir (concat njord-emacs-dir ".local/")
  "Root directory for local Emacs files.")

(defvar njord-host-dir (concat njord-local-dir "@" (system-name))
  "Directory for hostname-specific file storage.")

(defvar njord-etc-dir (concat njord-host-dir "/etc/")
  "Host-namespaced directory for non-volatile storage. Use this for dependnecies
like servers or config files that are stable.")

(defvar njord-cache-dir (concat njord-host-dir "/cache/")
  "Host-namespaced directory for volatile storage. Deleted when `njord/reset' is
called. Use for transient files.")

(defvar njord-packages-dir (concat njord-local-dir "packages/")
  "Where packages.el and quelpa plugins are stored.")

(defvar njord-autoload-file (concat njord-local-dir "autoloads.el")
  "Location of autoloads file generated by `njord/reload-autoloads'.")

(defgroup njord nil
  "Njord Emacs."
  :group 'emacs)

;;;
;; UTF-8 as the default coding system.
(when (fboundp 'set-charset-priority)
  (set-charset-priority 'unicode))
(prefer-coding-system 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(set-selection-coding-system 'utf-8)
(setq locale-coding-system 'utf-8)
(setq-default buffer-file-coding-system 'utf-8)

(setq-default
 ad-redefinition-action 'accept ;; silence advised function warnings.
 apropos-do-all t               ;; make `apropos' more useful.
 compilation-always-kill        ;; kill compile process before starting another.
 compilation-ask-about-save nil ;; save all buffers on `compile'.
 compilation-scroll-output t
 confirm-nonexistent-file-or-buffer t
 enable-recursive-minibuffers nil
 debug-on-error (and (not noninteractive) njord-debug-mode)
 idle-update-delay 2            ;; update UI less often.
 ;; keep the point out of the minibuffer.
 minibuffer-prompt-properties '(read-only t
                                          point-entered minibuffer-avoid-prompt
                                          face minibuffer-prompt)
 auto-save-default nil
 create-lockfiles nil
 history-length 500
 make-backup-files nil
 abbrev-file-name (concat njord-local-dir "abbrev.el")
 auto-save-list-file-name (concat njord-cache-dir "autosave")
 backup-directory-alist (list (const "." (concat njord-cache-dir "backup/")))
 pcache-directory (concat njord-cache-dir "pcache/")
 server-auth-dir (concat njord-cache-dir "server/")
 shared-game-score-directory (concat njord-etc-dir "shared-game-score/")
 tramp-auto-save-directory (concat njord-cache-dir "tramp-auto-save/")
 tramp-backup-directory-alist backup-directory-alist
 tramp-persistency-file-name (concat njord-cache-dir "tramp-persistency.el")
 url-cache-directory (concat njord-cache-dir "url/")
 url-configuration-directory (concat njord-etc-dir "url/"))

(setq custom-file (concat njord-etc-dir "custom.el"))
(load custom-file t t)

;; be quiet at startup.
(advice-add #'display-startup-echo-area-message :override #'ignore)
(setq inhibit-startup-message t
      inhibit-startup-echo-area-message user-login-name
      inhibit-default-init t
      initial-major-mode 'org-mode
      initial-scratch-message nil
      mode-line-format nil)

;; Custom init hooks.
(defvar njord-init-hook nil
  "A list of hooks run when Njord is initialized, before `njord-startup-hook'.")

(defvar njord-post-init-hook nil
  "A list of hooks run after `njord-init-hook'.")

(defun njord-try-run-hook (fn hook)
  "Runs a hook wrapped in a `condition-case-unless-debug' block."
  (condition-case-unless-debug ex
      (if noninteractive
          (quiet! (funcall fn))
        (funcall fn))
    ('error
     (lwarn hook :error
            "%s in '%s' -> %s"
            (car ex) fn (error-message-string ex))))
  nil)

(defun njord|finalize ()
  (unless (or njord-init-p noninteractive)
    (dolist (hook '(njord-init-hook njord-post-init-hook))
      (run-hook-wrapped hook #'njord-try-run-hook hook))
    (setq njord-init-p t))

  (setq gc-cons-threshold 16777216
        gc-cons-percentage 0.1
        file-name-handler-alist njord--file-handler-alist))

;;; Initialize.
(eval-and-compile
  (defvar njord--file-name-handler-alist file-name-handler-alist)
  (setq gc-cons-threshold 402653184
        gc-cons-percentage 0.6
        file-name-handler-alist nil)

  (require 'cl-lib)
  (require 'core-packages (concat njord-core-dir "core-packages"))

  (eval-when-compile (njord-initialize))
  (setq load-path (eval-when-compile load-path)
        njord--package-load-path (eval-when-compile njord--package-load-path))

  (load! core-lib)
  (load! core-os)
  (condition-case-unless-debug ex
      (require 'autoloads njord-autoload-file t)
    ('error
     (lwarn 'njord-autoloads :warning
            "%s in autoloads.el -> %s"
            (car ex) (error-message-string ex))))

  (unless noninteractive
    (load! core-ui)
    (load! core-popups)
    (load! core-editor)
    (load! core-projects)
    (load! core-keybinds)))

(add-hook! '(emacs-startup-hook njord-reload-hook)
           #'njord|finalize)

(provide 'core)
